<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabBoost - Nâng cấp Từ vựng C1/C2</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ96aWjM9L+oE8hL+J6o/qQnN7D6b7Xp+VwW5mN/yK95L3tC8R8W1p/2T5f5w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-primary: #F9FAFB;
            --bg-secondary: #F3F4F6;
            --bg-tertiary: #E5E7EB;
            --text-primary: #111827;
            --text-secondary: #4B5563;
            --border-color: #D1D5DB;
            --purple: #8B5CF6;
            --teal: #14B8A6;
            --red: #EF4444;
            --orange: #F97316;
            --blue: #3B82F6;
        }

        .dark {
            --bg-primary: #0E1015;
            --bg-secondary: #1F2937;
            --bg-tertiary: #374151;
            --text-primary: #F9FAFB;
            --text-secondary: #9CA3AF;
            --border-color: #4B5563;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* General component styling using variables */
        .container { max-width: 1000px; }
        .main-content { background-color: var(--bg-secondary); }
        .card { background-color: var(--bg-tertiary); }
        .input-field { background-color: var(--bg-primary); border-color: var(--border-color); }
        .text-secondary { color: var(--text-secondary); }
        .border-color { border-color: var(--border-color); }
        .purple-text { color: var(--purple); }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background-color: var(--purple); border-radius: 4px; border: 2px solid var(--bg-secondary); }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Section Transitions */
        .content-section, .review-subsection { display: none; }
        .content-section.active, .review-subsection.active { display: block; }

        /* Flashcard Flip Effect */
        .perspective-1000 { perspective: 1000px; }
        .flashcard-inner { transform-style: preserve-3d; transition: transform 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .flashcard-face { -webkit-backface-visibility: hidden; backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        /* Custom Popups & Modals */
        .custom-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .custom-overlay.is-visible { opacity: 1; visibility: visible; }
        .custom-modal-box { background-color: var(--bg-secondary); border: 1px solid var(--border-color); padding: 2.5rem; border-radius: 1rem; box-shadow: 0 15px 25px rgba(0, 0, 0, 0.5); transform: scale(0.8); opacity: 0; transition: transform 0.3s ease-out, opacity 0.3s ease-out; max-width: 500px; }
        .custom-overlay.is-visible .custom-modal-box { transform: scale(1); opacity: 1; }
        #wordPopup { position: absolute; z-index: 1001; transform: scale(0.8); opacity: 0; visibility: hidden; transition: opacity 0.2s ease, transform 0.2s ease; background-color: var(--bg-secondary); }
        #wordPopup.is-visible { opacity: 1; visibility: visible; transform: scale(1); }

        /* Word Levels Colors */
        .level-tag.b2-level, .highlighted-word.b2-level { color: var(--blue); }
        .level-tag.c1-level, .highlighted-word.c1-level { color: var(--orange); }
        .level-tag.c2-level, .highlighted-word.c2-level { color: var(--red); }
        .level-tag { background-color: var(--bg-primary); border: 1px solid; padding: 2px 8px; font-size: 0.75rem; border-radius: 9999px; font-weight: 600; }
        .level-tag.b2-level { border-color: var(--blue); }
        .level-tag.c1-level { border-color: var(--orange); }
        .level-tag.c2-level { border-color: var(--red); }

        /* Loading Spinner */
        .loading-spinner { border: 3px solid rgba(129, 140, 153, 0.3); border-top-color: var(--purple); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Custom Alert Modal -->
    <div id="customAlertOverlay" class="custom-overlay">
        <div class="custom-modal-box text-center">
            <div id="customAlertMessage" class="text-lg mb-6"></div>
            <button id="customAlertCloseBtn" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-full transition-colors">Đóng</button>
        </div>
    </div>

    <!-- Main Application Container -->
    <div class="container mx-auto">
        <!-- Header -->
        <header class="text-center mb-12 relative">
            <h1 class="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 drop-shadow-lg">VocabBoost</h1>
            <p class="text-lg text-secondary mt-2">Nâng cấp từ vựng tiếng Anh trình độ C1/C2 của bạn!</p>
            <!-- NEW: Theme Toggler -->
            <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full hover:bg-gray-500/20 transition-colors">
                <i id="theme-toggle-dark-icon" class="fa-solid fa-moon text-2xl text-secondary"></i>
                <i id="theme-toggle-light-icon" class="fa-solid fa-sun text-2xl text-secondary hidden"></i>
            </button>
        </header>

        <!-- Navigation Tabs -->
        <nav class="mb-10">
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6">
                <button id="createTab" class="px-8 py-3 rounded-full text-lg font-semibold transition-all duration-300">Tạo Tài liệu học</button>
                <button id="reviewTab" class="px-8 py-3 rounded-full text-lg font-semibold transition-all duration-300">Ôn Tập & Học</button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main id="mainContent" class="main-content relative p-6 sm:p-10 rounded-3xl shadow-2xl overflow-hidden min-h-[600px]">

            <!-- Create Materials Section -->
            <section id="create-materials" class="content-section">
                <h2 class="text-3xl font-bold text-center purple-text mb-8">Tạo Tài liệu học</h2>
                <div class="mb-10 p-6 sm:p-8 card rounded-2xl shadow-lg fade-in">
                    <h3 class="text-2xl font-semibold mb-6 border-b border-color pb-4"><i class="fa-solid fa-list-ol purple-text mr-3"></i> Tạo Bộ từ vựng & Flashcard</h3>
                    <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
                        <label class="font-medium flex-shrink-0">Cấp độ:</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center cursor-pointer"><input type="radio" name="vocabLevel" value="B2" class="form-radio text-purple-500 h-4 w-4" checked><span class="ml-2">B2</span></label>
                            <label class="inline-flex items-center cursor-pointer"><input type="radio" name="vocabLevel" value="C1/C2" class="form-radio text-purple-500 h-4 w-4"><span class="ml-2">C1/C2</span></label>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <input type="text" id="vocabTopicInput" placeholder="VD: '20 từ Khoa học' hoặc để trống để ngẫu nhiên" class="input-field flex-1 p-3 rounded-xl border focus:border-purple-500 focus:ring focus:ring-purple-500 focus:ring-opacity-50 placeholder-gray-500">
                        <button id="generateVocabBtn" class="px-6 py-3 bg-gradient-to-r from-teal-500 to-emerald-600 text-white font-bold rounded-xl shadow-md hover:from-teal-600 hover:to-emerald-700 transition-all duration-300">Tạo Từ Vựng</button>
                    </div>
                    <div class="mt-6 p-4 sm:p-6 bg-gray-900/20 dark:bg-black/20 rounded-xl shadow-inner min-h-[200px]">
                        <p id="vocabLoading" class="purple-text hidden flex items-center justify-center text-lg space-x-2"><span class="loading-spinner"></span> <span>Đang tạo từ vựng...</span></p>
                        <p id="vocabError" class="text-red-500 hidden text-center"></p>
                        <ul id="vocabList" class="space-y-4"></ul>
                        <p id="noVocabMessage" class="text-secondary text-center py-10">Chưa có từ vựng nào được tạo.</p>
                        <div id="vocabActionButtons" class="mt-6 flex flex-col sm:flex-row gap-4 hidden">
                            <button id="cancelEditBtn" class="flex-1 py-3 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded-xl shadow-lg">Hủy bỏ</button>
                            <button id="saveFlashcardsBtn" class="flex-1 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-xl shadow-lg">Lưu thành Bộ Flashcard</button>
                        </div>
                    </div>
                </div>
                <div class="p-6 sm:p-8 card rounded-2xl shadow-lg fade-in">
                    <h3 class="text-2xl font-semibold mb-6 border-b border-color pb-4"><i class="fa-solid fa-file-lines purple-text mr-3"></i> Tạo Tài liệu từ vựng chuyên sâu</h3>
                    <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
                        <label class="font-medium flex-shrink-0">Loại văn bản:</label>
                        <select id="documentTypeSelect" class="input-field flex-1 p-3 rounded-xl border focus:border-purple-500 focus:ring focus:ring-purple-500 focus:ring-opacity-50">
                            <option value="bài tin tức ngắn">Tin tức</option>
                            <option value="đoạn trích từ một bài báo khoa học">Bài báo khoa học</option>
                            <option value="một bài blog về công nghệ">Bài blog</option>
                            <option value="một bài luận học thuật ngắn">Bài luận học thuật</option>
                            <option value="một email trang trọng">Email trang trọng</option>
                            <option value="một bài phát biểu ngắn">Bài phát biểu</option>
                            <option value="một bài đánh giá sản phẩm">Đánh giá sản phẩm</option>
                            <option value="một đoạn truyện ngắn">Đoạn truyện ngắn</option>
                        </select>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <input type="text" id="documentTopicInput" placeholder="Nhập chủ đề (VD: 'AI trong y học') hoặc để trống" class="input-field flex-1 p-3 rounded-xl border focus:border-purple-500 focus:ring focus:ring-purple-500 focus:ring-opacity-50">
                        <button id="generateDocumentBtn" class="px-6 py-3 bg-gradient-to-r from-orange-400 to-red-500 text-white font-bold rounded-xl shadow-md hover:from-orange-500 hover:to-red-600">Tạo Tài liệu</button>
                    </div>
                    <div class="mt-6 p-4 sm:p-6 bg-gray-900/20 dark:bg-black/20 rounded-xl shadow-inner min-h-[200px]">
                        <p id="documentLoading" class="purple-text hidden flex items-center justify-center text-lg space-x-2"><span class="loading-spinner"></span> <span>Đang tạo tài liệu...</span></p>
                        <p id="documentError" class="text-red-500 hidden text-center"></p>
                        <div id="documentContent" class="leading-relaxed text-base"><p id="noDocumentMessage" class="text-secondary text-center py-10">Chưa có tài liệu nào được tạo.</p></div>
                        <button id="saveDocumentBtn" class="mt-6 w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-xl shadow-lg hidden">Lưu Tài liệu</button>
                    </div>
                </div>
            </section>

            <!-- Review & Learn Section -->
            <section id="review-learn" class="content-section">
                <h2 class="text-3xl font-bold text-center purple-text mb-8">Ôn Tập & Học</h2>
                <div class="flex justify-center border-b border-color mb-6">
                    <button id="reviewFlashcardsBtn" class="review-nav-btn px-6 py-3 text-lg font-semibold">Bộ Flashcard</button>
                    <button id="reviewDocumentsBtn" class="review-nav-btn px-6 py-3 text-lg font-semibold">Tài liệu</button>
                </div>
                <div id="flashcardListContainer" class="review-subsection fade-in"><div id="flashcardSets" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><p id="noFlashcardSetsMessage" class="col-span-full text-secondary text-center py-10">Bạn chưa có bộ flashcard nào được lưu.</p></div></div>
                <div id="flashcardLearningArea" class="review-subsection"><button id="backToFlashcardListBtn" class="purple-text hover:text-purple-400 mb-6 text-lg font-semibold flex items-center gap-2"><i class="fa-solid fa-arrow-left"></i> Trở về</button><div class="text-center mb-6"><h3 id="currentFlashcardSetTitle" class="text-3xl font-bold purple-text"></h3><p id="flashcardCounter" class="text-secondary mt-2 text-lg"></p></div><div class="perspective-1000 w-full max-w-xl mx-auto h-96"><div class="relative h-full"><div id="flashcardInner" class="flashcard-inner relative w-full h-full rounded-2xl shadow-xl card cursor-pointer"><div id="flashcardFront" class="flashcard-face absolute w-full h-full p-8 rounded-2xl flex flex-col justify-center items-center text-center"><p class="text-secondary text-sm mb-2">Từ vựng</p><h4 id="flashcardWord" class="text-5xl font-extrabold mb-4"></h4><p id="flashcardIpa" class="text-secondary text-2xl"></p></div><div id="flashcardBack" class="flashcard-face absolute w-full h-full p-8 rounded-2xl flex flex-col justify-start items-start rotate-y-180"><button id="backPronounceBtn" class="self-end purple-text hover:text-purple-400 text-3xl absolute top-6 right-6"><i class="fa-solid fa-volume-high"></i></button><p class="text-secondary text-sm">Từ vựng</p><h4 id="backFlashcardWord" class="text-3xl font-bold mb-2"></h4><p id="backFlashcardLevel" class="level-tag mb-4"></p><p class="text-secondary text-sm">Phiên âm</p><p id="backFlashcardIpa" class="text-xl mb-4"></p><p class="text-secondary text-sm">Nghĩa</p><p id="backFlashcardMeaning" class="text-lg mb-4"></p><p class="text-secondary text-sm">Ví dụ</p><p id="backFlashcardExample" class="italic text-base"></p></div></div></div></div><div class="flex justify-center items-center gap-6 mt-8"><button id="prevCardBtn" class="px-6 py-3 rounded-full card font-bold shadow-lg hover:bg-gray-400/50 disabled:opacity-50"><i class="fa-solid fa-arrow-left"></i> Trước</button><button id="nextCardBtn" class="px-6 py-3 rounded-full card font-bold shadow-lg hover:bg-gray-400/50 disabled:opacity-50">Tiếp theo <i class="fa-solid fa-arrow-right"></i></button></div></div>
                <div id="documentListContainer" class="review-subsection"><div id="documentSets" class="space-y-4"><p id="noDocumentSetsMessage" class="text-secondary text-center py-10">Bạn chưa có tài liệu nào được lưu.</p></div></div>
                <div id="documentReadingArea" class="review-subsection"><button id="backToDocumentListBtn" class="purple-text hover:text-purple-400 mb-6 text-lg font-semibold flex items-center gap-2"><i class="fa-solid fa-arrow-left"></i> Trở về</button><div class="text-center mb-6"><h3 id="currentDocumentTitle" class="text-3xl font-bold purple-text"></h3></div><div id="readingDocumentContent" class="card p-6 sm:p-8 rounded-2xl shadow-inner leading-relaxed text-lg"></div><button id="createFlashcardFromDocumentBtn" class="mt-6 w-full py-3 bg-gradient-to-r from-teal-500 to-emerald-600 text-white font-bold rounded-xl shadow-lg hover:from-teal-600 hover:to-emerald-700">Tạo Flashcard từ Tài liệu</button></div>
            </section>
        </main>

        <!-- Guide Button -->
        <button id="guideBtn" class="fixed bottom-6 right-6 px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-full shadow-lg transform hover:scale-105 flex items-center gap-2"><i class="fa-solid fa-circle-question"></i> Hướng dẫn</button>
    </div>

    <!-- Word Meaning Popup -->
    <div id="wordPopup" class="absolute p-4 rounded-xl shadow-2xl border border-color max-w-sm"><div id="popupContent" class="space-y-2"></div></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const mainContent = document.getElementById('mainContent');
            const createTab = document.getElementById('createTab');
            const reviewTab = document.getElementById('reviewTab');
            const createMaterialsSection = document.getElementById('create-materials');
            const reviewLearnSection = document.getElementById('review-learn');
            const vocabTopicInput = document.getElementById('vocabTopicInput');
            const generateVocabBtn = document.getElementById('generateVocabBtn');
            const vocabLoading = document.getElementById('vocabLoading');
            const vocabError = document.getElementById('vocabError');
            const vocabList = document.getElementById('vocabList');
            const noVocabMessage = document.getElementById('noVocabMessage');
            const vocabActionButtons = document.getElementById('vocabActionButtons');
            const saveFlashcardsBtn = document.getElementById('saveFlashcardsBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const documentTopicInput = document.getElementById('documentTopicInput');
            const generateDocumentBtn = document.getElementById('generateDocumentBtn');
            const documentLoading = document.getElementById('documentLoading');
            const documentError = document.getElementById('documentError');
            const documentContent = document.getElementById('documentContent');
            const saveDocumentBtn = document.getElementById('saveDocumentBtn');
            const reviewFlashcardsBtn = document.getElementById('reviewFlashcardsBtn');
            const reviewDocumentsBtn = document.getElementById('reviewDocumentsBtn');
            const flashcardListContainer = document.getElementById('flashcardListContainer');
            const flashcardSetsContainer = document.getElementById('flashcardSets');
            const noFlashcardSetsMessage = document.getElementById('noFlashcardSetsMessage');
            const flashcardLearningArea = document.getElementById('flashcardLearningArea');
            const backToFlashcardListBtn = document.getElementById('backToFlashcardListBtn');
            const currentFlashcardSetTitle = document.getElementById('currentFlashcardSetTitle');
            const flashcardCounter = document.getElementById('flashcardCounter');
            const flashcardInner = document.getElementById('flashcardInner');
            const flashcardWord = document.getElementById('flashcardWord');
            const flashcardIpa = document.getElementById('flashcardIpa');
            const backFlashcardWord = document.getElementById('backFlashcardWord');
            const backFlashcardLevel = document.getElementById('backFlashcardLevel');
            const backFlashcardIpa = document.getElementById('backFlashcardIpa');
            const backFlashcardMeaning = document.getElementById('backFlashcardMeaning');
            const backFlashcardExample = document.getElementById('backFlashcardExample');
            const prevCardBtn = document.getElementById('prevCardBtn');
            const nextCardBtn = document.getElementById('nextCardBtn');
            const backPronounceBtn = document.getElementById('backPronounceBtn');
            const documentListContainer = document.getElementById('documentListContainer');
            const documentSetsContainer = document.getElementById('documentSets');
            const noDocumentSetsMessage = document.getElementById('noDocumentSetsMessage');
            const documentReadingArea = document.getElementById('documentReadingArea');
            const backToDocumentListBtn = document.getElementById('backToDocumentListBtn');
            const currentDocumentTitle = document.getElementById('currentDocumentTitle');
            const readingDocumentContent = document.getElementById('readingDocumentContent');
            const createFlashcardFromDocumentBtn = document.getElementById('createFlashcardFromDocumentBtn');
            const customAlertOverlay = document.getElementById('customAlertOverlay');
            const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');
            const wordPopup = document.getElementById('wordPopup');
            const themeToggleBtn = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');

            // --- State Variables ---
            let generatedVocabData = [];
            let editingFlashcardSetId = null;
            let generatedDocumentData = {};
            let currentFlashcardSet = [];
            let currentCardIndex = 0;
            let sourceDocumentTitleForFlashcard = null;
            let isFetchingWordInfo = false; // Lock for popup API calls

            // --- LocalStorage Helpers ---
            const getStoredFlashcardSets = () => JSON.parse(localStorage.getItem('vocabBoostFlashcards') || '[]');
            const saveStoredFlashcardSets = (sets) => localStorage.setItem('vocabBoostFlashcards', JSON.stringify(sets));
            const getStoredDocuments = () => JSON.parse(localStorage.getItem('vocabBoostDocuments') || '[]');
            const saveStoredDocuments = (docs) => localStorage.setItem('vocabBoostDocuments', JSON.stringify(docs));

            // --- Core Functions ---
            function showCustomAlert(message, isHtml = false) {
                const msgElement = document.getElementById('customAlertMessage');
                msgElement.innerHTML = isHtml ? message : '';
                if (!isHtml) msgElement.textContent = message;
                customAlertOverlay.classList.add('is-visible');
            }

            function switchTab(tabName) {
                const navButtons = { create: createTab, review: reviewTab };
                Object.values(navButtons).forEach(btn => {
                    btn.classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-indigo-600', 'text-white', 'shadow-lg', 'scale-105');
                    btn.classList.add('bg-gray-700/50', 'dark:bg-gray-700', 'text-secondary');
                });
                navButtons[tabName].classList.add('bg-gradient-to-r', 'from-purple-600', 'to-indigo-600', 'text-white', 'shadow-lg', 'scale-105');
                navButtons[tabName].classList.remove('bg-gray-700/50', 'dark:bg-gray-700', 'text-secondary');

                createMaterialsSection.classList.toggle('active', tabName === 'create');
                reviewLearnSection.classList.toggle('active', tabName === 'review');
                
                if (tabName === 'review') {
                    switchReviewSubSection('flashcardList');
                }
            }
            
            function switchReviewSubSection(sectionId) {
                document.querySelectorAll('.review-subsection').forEach(sec => sec.classList.remove('active'));
                const element = document.getElementById(sectionId + 'Container') || document.getElementById(sectionId + 'Area');
                if (element) element.classList.add('active');

                const isFlashcard = sectionId.includes('flashcard');
                reviewFlashcardsBtn.classList.toggle('border-purple-500', isFlashcard);
                reviewFlashcardsBtn.classList.toggle('text-primary', isFlashcard);
                reviewFlashcardsBtn.classList.toggle('border-transparent', !isFlashcard);
                reviewFlashcardsBtn.classList.toggle('text-secondary', !isFlashcard);

                reviewDocumentsBtn.classList.toggle('border-purple-500', !isFlashcard);
                reviewDocumentsBtn.classList.toggle('text-primary', !isFlashcard);
                reviewDocumentsBtn.classList.toggle('border-transparent', isFlashcard);
                reviewDocumentsBtn.classList.toggle('text-secondary', isFlashcard);
            }

            // --- Vocabulary & Flashcard Functions ---
            async function generateVocabulary() {
                editingFlashcardSetId = null;
                sourceDocumentTitleForFlashcard = null;
                const selectedLevel = document.querySelector('input[name="vocabLevel"]:checked').value;
                const wordCount = selectedLevel === 'B2' ? 15 : 10;
                const topic = vocabTopicInput.value || `một danh sách ${wordCount} từ vựng ${selectedLevel} khác nhau`;

                vocabLoading.classList.remove('hidden');
                vocabError.classList.add('hidden');
                noVocabMessage.classList.add('hidden');
                vocabActionButtons.classList.add('hidden');
                vocabList.innerHTML = '';

                const prompt = `Tạo một danh sách các từ vựng tiếng Anh **khác nhau** (không trùng lặp) theo yêu cầu: "${topic}". Cấp độ từ vựng là ${selectedLevel}. Với mỗi từ, cung cấp: word (luôn là chữ thường), ipa, type, meaning (tiếng Việt), example (tiếng Anh), và level (phải là "B2", "C1", hoặc "C2"). Trả về một mảng JSON.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "word": { "type": "STRING" }, "ipa": { "type": "STRING" }, "type": { "type": "STRING" }, "meaning": { "type": "STRING" }, "example": { "type": "STRING" }, "level": { "type": "STRING", "enum": ["B2", "C1", "C2"] } }, required: ["word", "ipa", "type", "meaning", "example", "level"] } }
                    }
                };

                try {
                    let result = await callGeminiAPI(payload);
                    if (Array.isArray(result) && result.length > 0) {
                        const uniqueWords = [...new Map(result.map(item => [item.word.toLowerCase(), item])).values()];
                        generatedVocabData = uniqueWords;
                        renderGeneratedVocab(generatedVocabData);
                        vocabActionButtons.classList.remove('hidden');
                        saveFlashcardsBtn.textContent = "Lưu thành Bộ Flashcard";
                    } else { throw new Error("Không có từ vựng nào được tạo."); }
                } catch (error) {
                    vocabError.textContent = "Lỗi: " + error.message;
                    vocabError.classList.remove('hidden');
                    noVocabMessage.classList.remove('hidden');
                } finally {
                    vocabLoading.classList.add('hidden');
                }
            }
            
            function renderGeneratedVocab(vocab) {
                vocabList.innerHTML = '';
                noVocabMessage.classList.toggle('hidden', vocab.length > 0);

                vocab.forEach((item, index) => {
                    const li = document.createElement('li');
                    const levelClass = item.level ? `${item.level.toLowerCase()}-level` : '';
                    let borderColorClass = 'border-gray-500';
                    if(item.level === 'B2') borderColorClass = 'border-blue-500';
                    else if(item.level === 'C1') borderColorClass = 'border-orange-500';
                    else if(item.level === 'C2') borderColorClass = 'border-red-500';

                    li.className = `flex items-center justify-between card p-4 rounded-xl border-l-4 ${borderColorClass}`;
                    li.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center"><span class="text-xl font-bold">${item.word || 'N/A'}</span><button class="pronounce-btn purple-text hover:text-purple-400 ml-3 text-lg" data-word="${item.word}"><i class="fa-solid fa-volume-high"></i></button></div>
                            <p class="text-secondary text-sm italic mt-1">${item.ipa || 'N/A'}</p>
                            <p class="mt-2">${item.meaning || 'N/A'} <span class="level-tag ${levelClass}">${item.level || 'N/A'}</span></p>
                            <p class="text-secondary text-sm mt-1">Ví dụ: "${item.example || 'N/A'}"</p>
                        </div>
                        <button class="delete-vocab-btn text-red-500 hover:text-red-400 p-2 rounded-full" data-index="${index}"><i class="fa-solid fa-xmark"></i></button>
                    `;
                    vocabList.appendChild(li);
                });

                vocabList.querySelectorAll('.delete-vocab-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    generatedVocabData.splice(parseInt(e.currentTarget.dataset.index), 1);
                    renderGeneratedVocab(generatedVocabData);
                }));
                vocabList.querySelectorAll('.pronounce-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    pronounceText(e.currentTarget.dataset.word);
                }));
            }

            function saveOrUpdateFlashcardSet() {
                if (generatedVocabData.length === 0) return showCustomAlert("Vui lòng tạo từ vựng trước khi lưu.");
                const allSets = getStoredFlashcardSets();
                
                let title;
                let level = "N/A";
                let isFromDoc = false;

                if (sourceDocumentTitleForFlashcard) {
                    title = `Từ vựng từ: ${sourceDocumentTitleForFlashcard}`;
                    isFromDoc = true;
                } else {
                    level = document.querySelector('input[name="vocabLevel"]:checked').value;
                    title = `Bộ từ vựng cấp độ ${level} (${generatedVocabData.length} từ)`;
                }

                if (editingFlashcardSetId) {
                    const setIndex = allSets.findIndex(s => s.id === editingFlashcardSetId);
                    if (setIndex > -1) allSets[setIndex] = { ...allSets[setIndex], title, level, vocabularies: generatedVocabData, timestamp: new Date().toISOString(), isFromDocument: isFromDoc };
                } else {
                    allSets.push({ id: Date.now(), title, level, vocabularies: generatedVocabData, timestamp: new Date().toISOString(), isFromDocument: isFromDoc });
                }

                saveStoredFlashcardSets(allSets);
                renderFlashcardSets(allSets);
                showCustomAlert(`Đã lưu thành công bộ flashcard: "${title}".`);
                resetVocabForm();
            }

            function resetVocabForm() {
                generatedVocabData = [];
                vocabList.innerHTML = '';
                noVocabMessage.classList.remove('hidden');
                vocabActionButtons.classList.add('hidden');
                vocabTopicInput.value = '';
                editingFlashcardSetId = null;
                sourceDocumentTitleForFlashcard = null;
            }

            function editFlashcardSet(id) {
                const set = getStoredFlashcardSets().find(s => s.id === id);
                if (set) {
                    editingFlashcardSetId = id;
                    generatedVocabData = set.vocabularies;
                    sourceDocumentTitleForFlashcard = set.isFromDocument ? set.title.replace('Từ vựng từ: ', '') : null;
                    renderGeneratedVocab(generatedVocabData);
                    vocabActionButtons.classList.remove('hidden');
                    saveFlashcardsBtn.textContent = "Lưu thay đổi";
                    switchTab('create');
                }
            }

            function renderFlashcardSets(sets) {
                flashcardSetsContainer.innerHTML = '';
                noFlashcardSetsMessage.classList.toggle('hidden', sets.length > 0);
                if (sets.length === 0) flashcardSetsContainer.appendChild(noFlashcardSetsMessage);

                sets.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                sets.forEach(set => {
                    const setElement = document.createElement('div');
                    let borderColorClass = 'border-gray-500';
                    if (set.isFromDocument) {
                        borderColorClass = 'border-teal-500';
                    } else if(set.level === 'B2') {
                        borderColorClass = 'border-blue-500';
                    } else if(set.level === 'C1/C2') { // Handle C1/C2 case
                        borderColorClass = 'border-purple-500';
                    }

                    setElement.className = `card p-6 rounded-2xl shadow-lg flex flex-col justify-between hover:bg-gray-400/20 border-l-4 ${borderColorClass}`;
                    setElement.innerHTML = `
                        <div>
                            <h4 class="text-xl font-bold mb-2">${set.title}</h4>
                            <p class="text-secondary text-sm">${set.isFromDocument ? '' : `<span class="font-semibold">${set.level}</span> &bull; `}${set.vocabularies.length} từ</p>
                            <p class="text-secondary text-xs mt-1">Đã tạo: ${new Date(set.timestamp).toLocaleDateString()}</p>
                        </div>
                        <div class="flex flex-wrap justify-end gap-2 mt-4">
                            <button class="view-btn text-sm px-3 py-1 rounded-full text-purple-500 hover:bg-purple-500/20"><i class="fa-solid fa-play mr-1"></i> Học</button>
                            <button class="edit-btn text-sm px-3 py-1 rounded-full text-teal-500 hover:bg-teal-500/20"><i class="fa-solid fa-pen-to-square mr-1"></i> Sửa</button>
                            <button class="delete-btn text-sm px-3 py-1 rounded-full text-red-500 hover:bg-red-500/20"><i class="fa-solid fa-trash-can mr-1"></i> Xóa</button>
                        </div>
                    `;
                    flashcardSetsContainer.appendChild(setElement);

                    setElement.querySelector('.view-btn').addEventListener('click', () => {
                        currentFlashcardSet = set.vocabularies;
                        currentCardIndex = 0;
                        currentFlashcardSetTitle.textContent = set.title;
                        showFlashcard(currentCardIndex);
                        switchReviewSubSection('flashcardLearning');
                    });
                    setElement.querySelector('.edit-btn').addEventListener('click', () => editFlashcardSet(set.id));
                    setElement.querySelector('.delete-btn').addEventListener('click', () => {
                        saveStoredFlashcardSets(getStoredFlashcardSets().filter(s => s.id !== set.id));
                        renderFlashcardSets(getStoredFlashcardSets());
                        showCustomAlert(`Đã xóa bộ flashcard: "${set.title}".`);
                    });
                });
            }

            function showFlashcard(index) {
                const card = currentFlashcardSet[index];
                if (!card) return;
                const levelClass = card.level ? `${card.level.toLowerCase()}-level` : '';
                flashcardWord.textContent = card.word;
                flashcardIpa.textContent = card.ipa;
                backFlashcardWord.textContent = card.word;
                backFlashcardIpa.textContent = card.ipa;
                backFlashcardMeaning.textContent = card.meaning;
                backFlashcardExample.innerHTML = card.example;
                backFlashcardLevel.textContent = card.level;
                backFlashcardLevel.className = `level-tag ${levelClass}`;
                flashcardCounter.textContent = `Thẻ ${index + 1} / ${currentFlashcardSet.length}`;
                prevCardBtn.disabled = index === 0;
                nextCardBtn.disabled = index === currentFlashcardSet.length - 1;
            }

            function navigateFlashcard(direction) {
                const isFlipped = flashcardInner.classList.contains('rotate-y-180');
                const updateCard = () => {
                    if (direction === 'next' && currentCardIndex < currentFlashcardSet.length - 1) currentCardIndex++;
                    else if (direction === 'prev' && currentCardIndex > 0) currentCardIndex--;
                    showFlashcard(currentCardIndex);
                };

                if (isFlipped) {
                    flashcardInner.classList.remove('rotate-y-180');
                    setTimeout(updateCard, 350);
                } else {
                    updateCard();
                }
            }
            
            // --- Document Functions ---
            async function generateDocument() {
                const documentType = document.getElementById('documentTypeSelect').value;
                const topic = documentTopicInput.value || "một chủ đề ngẫu nhiên thú vị từ các lĩnh vực như khoa học, lịch sử, nghệ thuật, hoặc văn hóa";

                documentLoading.classList.remove('hidden');
                documentError.classList.add('hidden');
                documentContent.innerHTML = '';
                saveDocumentBtn.classList.add('hidden');

                const prompt = `Viết một ${documentType} bằng tiếng Anh khoảng 200 từ về chủ đề: "${topic}". Sử dụng từ vựng ở các cấp độ B2, C1, và C2. Đánh dấu các từ khóa quan trọng bằng thẻ HTML, ví dụ: "<span class='highlighted-word' data-word='ubiquitous' data-level='C1'>ubiquitous</span>". Bắt buộc phải có thuộc tính data-level và giá trị của nó phải là "B2", "C1", hoặc "C2". Trả về một đối tượng JSON có thuộc tính "title" và "content_html".`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "title": { "type": "STRING" }, "content_html": { "type": "STRING" } }, required: ["title", "content_html"] } } };
                
                try {
                    const result = await callGeminiAPI(payload);
                    result.title = result.title.replace(/<[^>]*>?/gm, ''); // Sanitize title
                    generatedDocumentData = result;
                    renderGeneratedDocument(result);
                    saveDocumentBtn.classList.remove('hidden');
                } catch (error) {
                    documentError.textContent = "Lỗi: " + error.message;
                    documentError.classList.remove('hidden');
                } finally {
                    documentLoading.classList.add('hidden');
                }
            }

            function renderGeneratedDocument(data) {
                documentContent.innerHTML = data.content_html;
                documentContent.querySelectorAll('.highlighted-word').forEach(wordElement => {
                    const level = wordElement.dataset.level;
                    if (level) wordElement.classList.add(`${level.toLowerCase()}-level`);
                    wordElement.addEventListener('click', (e) => showWordPopup(e.currentTarget.dataset.word, level, e.currentTarget));
                });
            }

            function saveDocument() {
                if (!generatedDocumentData.title) return showCustomAlert("Vui lòng tạo tài liệu trước khi lưu.");
                const allDocs = getStoredDocuments();
                allDocs.push({ id: Date.now(), ...generatedDocumentData, timestamp: new Date().toISOString() });
                saveStoredDocuments(allDocs);
                renderDocumentSets(allDocs);
                showCustomAlert(`Đã lưu tài liệu: "${generatedDocumentData.title}".`);
                generatedDocumentData = {};
                documentContent.innerHTML = `<p id="noDocumentMessage" class="text-secondary text-center py-10">Chưa có tài liệu nào được tạo.</p>`;
                saveDocumentBtn.classList.add('hidden');
            }

            function renderDocumentSets(sets) {
                documentSetsContainer.innerHTML = '';
                noDocumentSetsMessage.classList.toggle('hidden', sets.length > 0);
                if (sets.length === 0) documentSetsContainer.appendChild(noDocumentSetsMessage);

                sets.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                sets.forEach(set => {
                    const setElement = document.createElement('div');
                    setElement.className = "card p-6 rounded-2xl shadow-lg flex flex-col justify-between hover:bg-gray-400/20";
                    setElement.innerHTML = `
                        <div>
                            <h4 class="text-xl font-bold mb-2">${set.title}</h4>
                            <p class="text-secondary text-xs mt-1">Đã tạo: ${new Date(set.timestamp).toLocaleDateString()}</p>
                        </div>
                        <div class="flex flex-wrap justify-end gap-2 mt-4">
                            <button class="read-btn text-sm px-3 py-1 rounded-full text-purple-500 hover:bg-purple-500/20"><i class="fa-solid fa-book-open mr-1"></i> Đọc</button>
                            <button class="create-fc-btn text-sm px-3 py-1 rounded-full text-green-500 hover:bg-green-500/20"><i class="fa-solid fa-plus mr-1"></i> Tạo Flashcard</button>
                            <button class="delete-btn text-sm px-3 py-1 rounded-full text-red-500 hover:bg-red-500/20"><i class="fa-solid fa-trash-can mr-1"></i> Xóa</button>
                        </div>
                    `;
                    documentSetsContainer.appendChild(setElement);

                    setElement.querySelector('.read-btn').addEventListener('click', () => {
                        currentDocumentTitle.textContent = set.title;
                        readingDocumentContent.innerHTML = set.content_html; 
                        readingDocumentContent.querySelectorAll('.highlighted-word').forEach(el => {
                            const level = el.dataset.level;
                            if(level) el.classList.add(`${level.toLowerCase()}-level`);
                            el.addEventListener('click', (e) => showWordPopup(e.currentTarget.dataset.word, level, e.currentTarget));
                        });
                        switchReviewSubSection('documentReading');
                    });

                    setElement.querySelector('.create-fc-btn').addEventListener('click', () => {
                        readingDocumentContent.innerHTML = set.content_html;
                        sourceDocumentTitleForFlashcard = set.title;
                        createFlashcardFromDocument();
                    });

                    setElement.querySelector('.delete-btn').addEventListener('click', () => {
                        saveStoredDocuments(getStoredDocuments().filter(d => d.id !== set.id));
                        renderDocumentSets(getStoredDocuments());
                        showCustomAlert(`Đã xóa tài liệu: "${set.title}".`);
                    });
                });
            }

            async function createFlashcardFromDocument() {
                if (!readingDocumentContent.hasChildNodes() || readingDocumentContent.textContent.trim() === '') return showCustomAlert("Tài liệu không có nội dung.");
                const highlightedWords = Array.from(readingDocumentContent.querySelectorAll('.highlighted-word'));
                if (highlightedWords.length === 0) return showCustomAlert("Tài liệu này không có từ vựng nào được đánh dấu.");

                showCustomAlert("Đang trích xuất từ vựng...");
                switchTab('create');
                vocabLoading.classList.remove('hidden');
                vocabList.innerHTML = '';
                noVocabMessage.classList.add('hidden');

                const wordsToProcess = highlightedWords.map(w => ({ word: w.dataset.word, level: w.dataset.level }));
                const uniqueWords = [...new Map(wordsToProcess.map(item => [item.word, item])).values()];
                
                const newVocabData = [];
                for (const item of uniqueWords) {
                    try {
                        const prompt = `Cung cấp nghĩa tiếng Việt, phiên âm IPA, và một câu ví dụ tiếng Anh cho từ "${item.word}" (cấp độ ${item.level}). Trả về một đối tượng JSON với các thuộc tính "ipa", "meaning", "example", và "type".`;
                        const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "ipa": { "type": "STRING" }, "meaning": { "type": "STRING" }, "example": { "type": "STRING" }, "type": { "type": "STRING" } }, required: ["ipa", "meaning", "example", "type"] } } };
                        const data = await callGeminiAPI(payload);
                        newVocabData.push({ ...item, ...data });
                    } catch (error) {
                        console.error(`Lỗi khi xử lý từ "${item.word}":`, error);
                    }
                }
                
                generatedVocabData = newVocabData;
                renderGeneratedVocab(generatedVocabData);
                vocabActionButtons.classList.remove('hidden');
                saveFlashcardsBtn.textContent = "Lưu thành Bộ Flashcard";
                vocabLoading.classList.add('hidden');
                showCustomAlert(`Đã trích xuất thành công ${newVocabData.length} từ! Bạn có thể xem lại và lưu.`);
            }

            // --- API & Utility Functions ---
            async function callGeminiAPI(payload) {
                const apiKey = "AIzaSyD_v3TF-xMvQzJkwNIu020D3pbPivWNy7s";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetchWithExponentialBackoff(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    try { return JSON.parse(result.candidates[0].content.parts[0].text); } 
                    catch (e) { throw new Error("Dữ liệu trả về không phải là JSON hợp lệ."); }
                } else { throw new Error(result.error?.message || "Không nhận được phản hồi hợp lệ từ API."); }
            }

            async function fetchWithExponentialBackoff(url, options, retries = 3, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response;
                    } catch (error) {
                        console.error(`Fetch attempt ${i + 1} failed:`, error);
                        if (i < retries - 1) await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                        else throw error;
                    }
                }
            }
            
            async function showWordPopup(word, level, target) {
                if (isFetchingWordInfo) return; // Debounce/lock mechanism
                isFetchingWordInfo = true;

                const popupContent = document.getElementById('popupContent');
                popupContent.innerHTML = `<div class="flex items-center justify-center gap-2 text-secondary text-sm"><span class="loading-spinner w-4 h-4 border-2"></span> Đang tải...</div>`;
                wordPopup.classList.add('is-visible');
                const targetRect = target.getBoundingClientRect();
                const mainRect = mainContent.getBoundingClientRect();
                const popupWidth = 300, popupHeight = 200, padding = 12;
                let popupLeft = targetRect.left + (targetRect.width / 2) - (popupWidth / 2) - mainRect.left;
                let popupTop = (targetRect.bottom - mainRect.top) + padding;
                
                popupLeft = Math.max(padding, Math.min(popupLeft, mainContent.clientWidth - popupWidth - padding));
                if (popupTop + popupHeight > mainContent.clientHeight) {
                    popupTop = (targetRect.top - mainRect.top) - popupHeight - padding;
                }
                popupTop = Math.max(padding, popupTop);

                wordPopup.style.left = `${popupLeft}px`;
                wordPopup.style.top = `${popupTop}px`;
                
                try {
                    const prompt = `Cung cấp nghĩa tiếng Việt, phiên âm IPA và một câu ví dụ tiếng Anh cho từ "${word}" ở cấp độ ${level}. Trả về một đối tượng JSON với các thuộc tính "ipa", "meaning" và "example".`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "ipa": { "type": "STRING" }, "meaning": { "type": "STRING" }, "example": { "type": "STRING" } } } } };
                    const data = await callGeminiAPI(payload);
                    const levelClass = level ? `${level.toLowerCase()}-level` : '';
                    popupContent.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2"><span class="text-xl font-bold">${word}</span><span class="level-tag ${levelClass}">${level}</span></div>
                            <button class="pronounce-word-popup purple-text hover:text-purple-400 text-2xl"><i class="fa-solid fa-volume-high"></i></button>
                        </div>
                        <p class="text-secondary italic text-sm">${data.ipa}</p>
                        <p><strong>Nghĩa:</strong> ${data.meaning}</p>
                        <p class="text-secondary text-sm italic"><strong>Ví dụ:</strong> ${data.example}</p>
                    `;
                    popupContent.querySelector('.pronounce-word-popup').addEventListener('click', () => pronounceText(word));
                } catch (error) {
                    popupContent.innerHTML = `<p class="text-red-500">Không thể lấy thông tin. Vui lòng thử lại.</p>`;
                } finally {
                    isFetchingWordInfo = false; // Release the lock
                }
            }

            function showGuide() {
                const guideMessage = `
                    <div class="text-left space-y-6">
                        <h3 class="text-2xl font-bold purple-text text-center">Chào mừng đến với VocabBoost!</h3>
                        <div class="p-4 card rounded-lg border-l-4 border-teal-400">
                            <h4 class="font-semibold text-lg text-teal-400 mb-2 flex items-center"><i class="fa-solid fa-wand-magic-sparkles w-6 mr-2"></i>Tạo Tài liệu học</h4>
                            <p class="text-secondary">Chọn cấp độ (B2, C1/C2) và nhập chủ đề để tạo bộ từ vựng hoặc tài liệu đọc. Bạn có thể lưu chúng lại để học sau.</p>
                        </div>
                        <div class="p-4 card rounded-lg border-l-4 border-pink-400">
                            <h4 class="font-semibold text-lg text-pink-400 mb-2 flex items-center"><i class="fa-solid fa-layer-group w-6 mr-2"></i>Ôn Tập & Học</h4>
                            <p class="text-secondary">Chọn "Bộ Flashcard" hoặc "Tài liệu" để xem lại. Bấm vào các từ được tô sáng trong tài liệu để xem nghĩa.</p>
                        </div>
                    </div>
                `;
                showCustomAlert(guideMessage, true);
            }

            // --- TTS Functions ---
            async function pronounceText(text) {
                const payload = { contents: [{ parts: [{ text: text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } }, model: "gemini-2.5-flash-preview-tts" };
                const apiKey = "AIzaSyD_v3TF-xMvQzJkwNIu020D3pbPivWNy7s";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                try {
                    const response = await fetchWithExponentialBackoff(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    const audioPart = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                    if (audioPart && audioPart.inlineData.mimeType.startsWith("audio/L16")) {
                        const sampleRate = parseInt(audioPart.inlineData.mimeType.match(/rate=(\d+)/)[1], 10);
                        const pcmData = base64ToArrayBuffer(audioPart.inlineData.data);
                        const wavBlob = pcmToWav(new Int16Array(pcmData), sampleRate);
                        new Audio(URL.createObjectURL(wavBlob)).play();
                    } else { throw new Error("No valid audio data received."); }
                } catch (error) { console.error("Lỗi khi phát âm:", error); }
            }
            function base64ToArrayBuffer(base64) {
                const binaryString = atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                return bytes.buffer;
            }
            function pcmToWav(pcmData, sampleRate) {
                const header = new ArrayBuffer(44);
                const view = new DataView(header);
                const dataSize = pcmData.length * 2;
                const writeString = (view, offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
                writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + dataSize, true); writeString(view, 8, 'WAVE');
                writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
                view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(view, 36, 'data');
                view.setUint32(40, dataSize, true);
                const pcmBytes = new Uint8Array(pcmData.buffer);
                const wavBytes = new Uint8Array(44 + dataSize);
                wavBytes.set(new Uint8Array(header), 0); wavBytes.set(pcmBytes, 44);
                return new Blob([wavBytes], { type: 'audio/wav' });
            }

            // --- Theme Toggler ---
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    darkIcon.classList.add('hidden');
                    lightIcon.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    darkIcon.classList.remove('hidden');
                    lightIcon.classList.add('hidden');
                }
            }

            themeToggleBtn.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                applyTheme(isDark ? 'dark' : 'light');
            });

            // --- Initial Load & Event Listeners ---
            createTab.addEventListener('click', () => switchTab('create'));
            reviewTab.addEventListener('click', () => switchTab('review'));
            reviewFlashcardsBtn.addEventListener('click', () => switchReviewSubSection('flashcardList'));
            reviewDocumentsBtn.addEventListener('click', () => switchReviewSubSection('documentList'));
            generateVocabBtn.addEventListener('click', generateVocabulary);
            saveFlashcardsBtn.addEventListener('click', saveOrUpdateFlashcardSet);
            cancelEditBtn.addEventListener('click', resetVocabForm);
            generateDocumentBtn.addEventListener('click', generateDocument);
            saveDocumentBtn.addEventListener('click', saveDocument);
            createFlashcardFromDocumentBtn.addEventListener('click', () => {
                sourceDocumentTitleForFlashcard = currentDocumentTitle.textContent;
                createFlashcardFromDocument();
            });
            backToFlashcardListBtn.addEventListener('click', () => switchReviewSubSection('flashcardList'));
            flashcardInner.addEventListener('click', () => flashcardInner.classList.toggle('rotate-y-180'));
            prevCardBtn.addEventListener('click', () => navigateFlashcard('prev'));
            nextCardBtn.addEventListener('click', () => navigateFlashcard('next'));
            backPronounceBtn.addEventListener('click', (e) => { e.stopPropagation(); if (currentFlashcardSet[currentCardIndex]) pronounceText(currentFlashcardSet[currentCardIndex].word); });
            backToDocumentListBtn.addEventListener('click', () => switchReviewSubSection('documentList'));
            customAlertCloseBtn.addEventListener('click', () => customAlertOverlay.classList.remove('is-visible'));
            document.getElementById('guideBtn').addEventListener('click', showGuide);
            
            vocabTopicInput.addEventListener('keyup', (e) => { if(e.key === 'Enter') generateVocabBtn.click() });
            documentTopicInput.addEventListener('keyup', (e) => { if(e.key === 'Enter') generateDocumentBtn.click() });

            document.addEventListener('click', (event) => {
                if (!wordPopup.contains(event.target) && !event.target.closest('.highlighted-word')) {
                    wordPopup.classList.remove('is-visible');
                }
            }, true);

            // Load saved theme or default to system preference
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));

            switchTab('create');
            renderFlashcardSets(getStoredFlashcardSets());
            renderDocumentSets(getStoredDocuments());
        });
    </script>
</body>
</html>
