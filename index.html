<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabBoost - Học Từ vựng Tiếng Anh C1/C2</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for Flashcard flip effect */
        body {
            font-family: 'Inter', sans-serif;
        }
        .perspective-1000 {
            perspective: 1000px;
        }
        .flashcard-inner {
            transform-style: preserve-3d;
        }
        .flashcard-face {
            -webkit-backface-visibility: hidden; /* For Safari */
            backface-visibility: hidden;
        }
        .rotate-y-180 {
            transform: rotateY(180deg);
        }
        /* Style for highlighted words in newsletter */
        .highlighted-word {
            font-weight: bold;
            text-decoration: underline;
            cursor: pointer;
            color: #8B5CF6; /* A purple shade for better visibility */
            position: relative; /* Needed for positioning the pronounce button inside */
            padding-right: 20px; /* Space for the speaker icon */
            display: inline-flex; /* To align icon with text baseline */
            align-items: baseline;
        }
        .highlighted-word .pronounce-btn-inline {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9em; /* Smaller icon for inline */
            margin-left: 0; /* Remove default margin */
            line-height: 1; /* Align with text */
        }

        /* Custom Alert Modal Styles */
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0; /* Start hidden */
            visibility: hidden; /* Hide from screen readers */
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-alert-overlay.is-visible {
            opacity: 1;
            visibility: visible;
        }
        .custom-alert-box {
            background-color: #1f2937; /* gray-800 */
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 1px solid #4b5563; /* gray-600 */
            transform: scale(0.9); /* Start slightly smaller */
            transition: transform 0.3s ease;
        }
        .custom-alert-overlay.is-visible .custom-alert-box {
            transform: scale(1); /* Scale up when visible */
        }
        .custom-alert-box p {
            color: #d1d5db; /* gray-300 */
            font-size: 1.125rem; /* text-lg */
            margin-bottom: 1.5rem;
        }
        .custom-alert-box button {
            background-color: #8B5CF6; /* purple-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .custom-alert-box button:hover {
            background-color: #7c3aed; /* purple-600 */
        }
        /* Pronunciation button style */
        .pronounce-btn {
            background: none;
            border: none;
            color: #a78bfa; /* purple-400 */
            cursor: pointer;
            font-size: 1.5rem;
            margin-left: 0.5rem;
            transition: color 0.2s ease;
        }
        .pronounce-btn:hover {
            color: #c4b5fd; /* purple-300 */
        }

        /* Gradient Hover Effect for Buttons */
        .btn-gradient-hover {
            position: relative;
            z-index: 1;
            overflow: hidden;
        }
        .btn-gradient-hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.0) 50%, rgba(255,255,255,0.1) 100%);
            transform: translateX(-100%);
            transition: transform 0.5s ease-out;
            z-index: -1;
        }
        .btn-gradient-hover:hover::before {
            transform: translateX(0%);
        }

        /* Section Transition Styles */
        /* These are for the main sections within the review tab */
        #flashcardListContainer, #flashcardLearningArea, #newsletterListContainer, #newsletterReadingArea {
            /* Use absolute positioning to prevent layout shifts during transitions */
            position: absolute; 
            width: 100%;
            left: 0;
            top: 0;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            pointer-events: none; /* Disable interaction when hidden */
        }
        #flashcardListContainer.is-visible, #flashcardLearningArea.is-visible, #newsletterListContainer.is-visible, #newsletterReadingArea.is-visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto; /* Enable interaction when visible */
            position: static; /* Revert to normal flow when active */
        }

        /* Adjust main content for absolute positioning during transition */
        main {
            position: relative;
            min-height: 500px; /* Ensure main has enough height for content */
        }

        /* Popup for word meaning - Fixed position for better alignment */
        #wordPopup {
            position: fixed; /* Changed to fixed */
            z-index: 1001; /* Higher than overlay */
            padding: 0.75rem 1rem; /* Adjusted padding */
            background-color: #6d28d9; /* purple-700 */
            color: white;
            border-radius: 0.5rem; /* Adjusted border-radius */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid #8B5CF6; /* purple-500 */
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform: translateY(-5px); /* Slight initial offset for transition */
            opacity: 0;
            visibility: hidden;
        }
        #wordPopup.is-visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* Loading Spinner Styles */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #8B5CF6; /* purple-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-900 text-white p-4 sm:p-6 lg:p-8">

    <!-- Custom Alert Modal -->
    <div id="customAlertOverlay" class="custom-alert-overlay hidden">
        <div class="custom-alert-box">
            <p id="customAlertMessage"></p>
            <button id="customAlertCloseBtn" class="btn-gradient-hover">Đóng</button>
        </div>
    </div>

    <!-- Header -->
    <header class="text-center mb-10">
        <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 drop-shadow-lg">
            VocabBoost
        </h1>
        <p class="text-lg text-gray-400 mt-2">Nâng tầm từ vựng tiếng Anh C1/C2 của bạn!</p>
    </header>

    <!-- Navigation Tabs -->
    <nav class="mb-8">
        <div class="flex justify-center space-x-4">
            <button id="createTab" class="px-6 py-3 rounded-full text-lg font-semibold transition duration-300 ease-in-out bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg transform scale-105">
                Tạo Tài Liệu Học
            </button>
            <button id="reviewTab" class="px-6 py-3 rounded-full text-lg font-semibold transition duration-300 ease-in-out bg-gray-700 text-gray-300 hover:bg-gray-600 hover:text-white">
                Ôn Tập & Học Tập
            </button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="max-w-4xl mx-auto bg-gray-800 p-6 rounded-xl shadow-2xl">

        <!-- Create Materials Section -->
        <section id="create-materials" class="tab-content">
            <h2 class="text-3xl font-bold text-center text-purple-300 mb-8">Tạo Tài Liệu Học</h2>

            <!-- Create Vocabulary & Flashcard Section -->
            <div class="mb-10 p-6 bg-gray-700 rounded-lg shadow-lg">
                <h3 class="text-2xl font-semibold text-white mb-4 border-b border-gray-600 pb-3">1. Tạo Bộ từ vựng & Flashcard</h3>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="text" id="vocabTopicInput" placeholder="Nhập chủ đề (ví dụ: 'Khoa học', 'Kinh tế') hoặc để trống để ngẫu nhiên" class="flex-1 p-3 rounded-md bg-gray-900 text-white border border-gray-600 focus:border-purple-500 focus:ring focus:ring-purple-500 focus:ring-opacity-50 placeholder-gray-500">
                    <button id="generateVocabBtn" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-bold rounded-lg shadow-md hover:from-blue-600 hover:to-cyan-600 transition duration-300 transform hover:scale-105 btn-gradient-hover">
                        Tạo Từ Vựng
                    </button>
                </div>
                <div id="generatedVocabOutput" class="mt-6 p-4 bg-gray-800 rounded-lg shadow-inner">
                    <h3 class="text-xl font-semibold text-white mb-4">Danh sách từ vựng đã tạo:</h3>
                    <p id="vocabLoading" class="text-purple-400 hidden flex items-center justify-center">
                        <span class="loading-spinner"></span> Đang tạo từ vựng...
                    </p>
                    <p id="vocabError" class="text-red-500 hidden"></p>
                    <ul id="vocabList" class="space-y-3"></ul>
                    <p id="noVocabMessage" class="text-gray-400">Chưa có từ vựng nào được tạo. Nhập chủ đề và nhấn "Tạo"!</p>
                    <button id="saveFlashcardsBtn" class="mt-6 w-full py-3 bg-gradient-to-r from-green-500 to-teal-500 text-white font-bold rounded-lg shadow-lg hover:from-green-600 hover:to-teal-600 transition duration-300 transform hover:scale-105 btn-gradient-hover hidden">
                        Lưu thành Bộ Flashcard
                    </button>
                </div>
            </div>

            <!-- Create Vocabulary Newsletter Section -->
            <div class="p-6 bg-gray-700 rounded-lg shadow-lg">
                <h3 class="text-2xl font-semibold text-white mb-4 border-b border-gray-600 pb-3">2. Tạo Bản tin Từ vựng</h3>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="text" id="newsletterTopicInput" placeholder="Nhập chủ đề (ví dụ: 'Công nghệ', 'Môi trường') hoặc để trống để ngẫu nhiên" class="flex-1 p-3 rounded-md bg-gray-900 text-white border border-gray-600 focus:border-purple-500 focus:ring focus:ring-purple-500 focus:ring-opacity-50 placeholder-gray-500">
                    <button id="generateNewsletterBtn" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-bold rounded-lg shadow-md hover:from-blue-600 hover:to-cyan-600 transition duration-300 transform hover:scale-105 btn-gradient-hover">
                        Tạo Bản Tin
                    </button>
                </div>
                <div id="generatedNewsletterOutput" class="mt-6 p-4 bg-gray-800 rounded-lg shadow-inner">
                    <h3 class="text-xl font-semibold text-white mb-4">Bản tin đã tạo:</h3>
                    <p id="newsletterLoading" class="text-purple-400 hidden flex items-center justify-center">
                        <span class="loading-spinner"></span> Đang tạo bản tin...
                    </p>
                    <p id="newsletterError" class="text-red-500 hidden"></p>
                    <div id="newsletterContent" class="text-gray-300 leading-relaxed text-base bg-gray-700 p-4 rounded-md shadow-sm"></div>
                    <p id="noNewsletterMessage" class="text-gray-400">Chưa có bản tin nào được tạo. Nhập chủ đề và nhấn "Tạo"!</p>
                    <button id="saveNewsletterBtn" class="mt-6 w-full py-3 bg-gradient-to-r from-green-500 to-teal-500 text-white font-bold rounded-lg shadow-lg hover:from-green-600 hover:to-teal-600 transition duration-300 transform hover:scale-105 btn-gradient-hover hidden">
                        Lưu Bản tin
                    </button>
                </div>
            </div>
        </section>

        <!-- Review & Learn Section -->
        <section id="review-learn" class="tab-content">
            <h2 class="text-3xl font-bold text-center text-purple-300 mb-8">Ôn Tập & Học Tập</h2>

            <!-- Learn via Flashcards Section -->
            <div class="mb-10 p-6 bg-gray-700 rounded-lg shadow-lg">
                <h3 class="text-2xl font-semibold text-white mb-4 border-b border-gray-600 pb-3">1. Học qua Flashcard</h3>
                <div id="flashcardListContainer" class="is-visible"> <!-- Container for flashcard grid -->
                    <div id="savedFlashcardGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <!-- Flashcard sets will be rendered here -->
                    </div>
                    <p id="noSavedFlashcardsMessage" class="text-gray-400 text-center">Chưa có bộ flashcard nào được lưu. Hãy tạo một bộ ở tab "Tạo Tài Liệu Học"!</p>
                </div>

                <div id="flashcardLearningArea" class="hidden"> <!-- New: Area for active flashcard learning -->
                    <div id="flashcardDisplay" class="flex flex-col items-center">
                        <!-- Flashcard -->
                        <div id="flashcardContainer" class="flashcard-container w-full max-w-md h-64 perspective-1000 cursor-pointer mb-6">
                            <div id="flashcardInner" class="flashcard-inner relative w-full h-full text-center rounded-xl shadow-xl transition-transform duration-700 ease-in-out">
                                <!-- Front Face -->
                                <div id="flashcardFront" class="flashcard-face flashcard-front absolute w-full h-full bg-gradient-to-br from-purple-700 to-indigo-700 rounded-xl flex items-center justify-center p-4 backface-hidden">
                                    <p id="flashcardWord" class="text-4xl font-bold text-white"></p>
                                    <button id="flashcardPronounceBtn" class="pronounce-btn absolute top-2 right-2" title="Nghe phát âm">
                                        &#128266; <!-- Speaker emoji -->
                                    </button>
                                </div>
                                <!-- Back Face -->
                                <div id="flashcardBack" class="flashcard-face flashcard-back absolute w-full h-full bg-gradient-to-br from-teal-600 to-green-600 rounded-xl flex flex-col items-center justify-center p-4 rotate-y-180 backface-hidden">
                                    <p id="flashcardMeaning" class="text-2xl font-bold text-white mb-2"></p>
                                    <p id="flashcardIPA" class="text-xl italic text-gray-100 mb-2"></p>
                                    <p id="flashcardExample" class="text-lg text-gray-200 text-center"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Flashcard Navigation Buttons -->
                        <div class="flex space-x-4">
                            <button id="prevFlashcardBtn" class="px-6 py-3 bg-gray-600 text-white font-bold rounded-full shadow-md hover:bg-gray-500 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed btn-gradient-hover">
                                Trước
                            </button>
                            <button id="nextFlashcardBtn" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-full shadow-md hover:from-purple-600 hover:to-pink-600 transition duration-300 btn-gradient-hover">
                                Tiếp theo
                            </button>
                        </div>
                        <p id="flashcardCounter" class="mt-4 text-gray-400"></p>
                    </div>
                    <button id="backToFlashcardListBtn" class="mt-6 w-full py-3 bg-gray-600 text-white font-bold rounded-lg shadow-lg hover:bg-gray-500 transition duration-300 transform hover:scale-105 btn-gradient-hover">
                        Quay về danh sách Flashcard
                    </button>
                </div>
                <p id="noFlashcardSetSelectedMessage" class="text-gray-400 text-center hidden">Vui lòng chọn một bộ flashcard để bắt đầu học.</p>
            </div>

            <!-- Learn via Newsletter Section -->
            <div class="p-6 bg-gray-700 rounded-lg shadow-lg">
                <h3 class="text-2xl font-semibold text-white mb-4 border-b border-gray-600 pb-3">2. Học qua Bản tin</h3>
                <div id="newsletterListContainer" class="is-visible"> <!-- Container for newsletter grid -->
                    <div id="savedNewsletterGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <!-- Newsletters will be rendered here -->
                    </div>
                    <p id="noSavedNewslettersMessage" class="text-gray-400 text-center">Chưa có bản tin nào được lưu. Hãy tạo một bản tin ở tab "Tạo Tài Liệu Học"!</p>
                </div>

                <div id="newsletterReadingArea" class="hidden"> <!-- New: Area for active newsletter reading -->
                    <!-- Removed "Đọc Bản Tin" button -->
                    <div id="selectedNewsletterContent" class="text-gray-300 leading-relaxed text-base bg-gray-800 p-4 rounded-md shadow-inner"></div>
                    <p id="noSelectedNewsletterContentMessage" class="text-gray-400 text-center hidden">Vui lòng chọn một bản tin để đọc và học.</p>
                    <button id="backToNewsletterListBtn" class="mt-6 w-full py-3 bg-gray-600 text-white font-bold rounded-lg shadow-lg hover:bg-gray-500 transition duration-300 transform hover:scale-105 btn-gradient-hover">
                        Quay về danh sách Bản tin
                    </button>
                </div>
                <!-- Pop-up for word meaning -->
                <div id="wordPopup" class="word-popup p-3 bg-purple-700 text-white rounded-lg shadow-xl border border-purple-500 hidden">
                    <p id="popupMeaning" class="font-bold"></p>
                    <p id="popupIPA" class="text-sm italic"></p>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="text-center text-gray-500 mt-10 text-sm">
        <p>&copy; 2025 VocabBoost. Bảo lưu mọi quyền.</p>
    </footer>

    <script>
        // Global variables for application state
        let activeTab = 'create';
        let generatedVocab = [];
        let generatedNewsletterHtml = ''; // Stores the processed HTML string for newsletter
        let savedFlashcards = [];
        let savedNewsletters = [];

        let currentFlashcardIndex = 0;
        let isFlipped = false;
        let shuffledFlashcards = [];
        let activeFlashcardSetId = null; // Changed from selectedFlashcardSet for clarity
        let activeNewsletterId = null; // New state for active newsletter

        // DOM elements
        const createTabBtn = document.getElementById('createTab');
        const reviewTabBtn = document.getElementById('reviewTab');
        const createMaterialsSection = document.getElementById('create-materials');
        const reviewLearnSection = document.getElementById('review-learn');

        const vocabTopicInput = document.getElementById('vocabTopicInput');
        const generateVocabBtn = document.getElementById('generateVocabBtn');
        const vocabLoading = document.getElementById('vocabLoading');
        const vocabError = document.getElementById('vocabError');
        const vocabList = document.getElementById('vocabList');
        const noVocabMessage = document.getElementById('noVocabMessage');
        const saveFlashcardsBtn = document.getElementById('saveFlashcardsBtn');

        const newsletterTopicInput = document.getElementById('newsletterTopicInput');
        const generateNewsletterBtn = document.getElementById('generateNewsletterBtn');
        const newsletterLoading = document.getElementById('newsletterLoading');
        const newsletterError = document.getElementById('newsletterError');
        const newsletterContentDiv = document.getElementById('newsletterContent'); // For create tab
        const noNewsletterMessage = document.getElementById('noNewsletterMessage');
        const saveNewsletterBtn = document.getElementById('saveNewsletterBtn');

        const flashcardListContainer = document.getElementById('flashcardListContainer'); // New container for flashcard grid
        const savedFlashcardGrid = document.getElementById('savedFlashcardGrid'); // New DOM element
        const noSavedFlashcardsMessage = document.getElementById('noSavedFlashcardsMessage'); // New DOM element
        const flashcardLearningArea = document.getElementById('flashcardLearningArea'); // New: Area for active flashcard learning
        const flashcardDisplay = document.getElementById('flashcardDisplay');
        const flashcardContainer = document.getElementById('flashcardContainer');
        const flashcardInner = document.getElementById('flashcardInner');
        const flashcardWord = document.getElementById('flashcardWord');
        const flashcardMeaning = document.getElementById('flashcardMeaning');
        const flashcardIPA = document.getElementById('flashcardIPA');
        const flashcardExample = document.getElementById('flashcardExample');
        const prevFlashcardBtn = document.getElementById('prevFlashcardBtn');
        const nextFlashcardBtn = document.getElementById('nextFlashcardBtn');
        const flashcardCounter = document.getElementById('flashcardCounter');
        const noFlashcardSetSelectedMessage = document.getElementById('noFlashcardSetSelectedMessage'); // Changed message ID
        const flashcardPronounceBtn = document.getElementById('flashcardPronounceBtn'); // New: Pronounce button for flashcard
        const backToFlashcardListBtn = document.getElementById('backToFlashcardListBtn'); // New: Back button

        const newsletterListContainer = document.getElementById('newsletterListContainer'); // New container for newsletter grid
        const savedNewsletterGrid = document.getElementById('savedNewsletterGrid'); // New DOM element
        const noSavedNewslettersMessage = document.getElementById('noSavedNewslettersMessage'); // New DOM element
        const newsletterReadingArea = document.getElementById('newsletterReadingArea'); // New: Area for active newsletter reading
        const selectedNewsletterContent = document.getElementById('selectedNewsletterContent'); // For review tab
        const noSelectedNewsletterContentMessage = document.getElementById('noSelectedNewsletterContentMessage'); // Changed message ID
        const backToNewsletterListBtn = document.getElementById('backToNewsletterListBtn'); // New: Back button
        // const readNewsletterContentBtn = document.getElementById('readNewsletterContentBtn'); // Removed: Read Newsletter button
        const wordPopup = document.getElementById('wordPopup');
        const popupMeaning = document.getElementById('popupMeaning');
        const popupIPA = document.getElementById('popupIPA');

        // Custom Alert DOM elements
        const customAlertOverlay = document.getElementById('customAlertOverlay');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');

        // --- Utility Functions ---

        // Show custom alert
        function showCustomAlert(message) {
            customAlertMessage.textContent = message;
            customAlertOverlay.classList.remove('hidden');
            customAlertOverlay.classList.add('is-visible');
        }

        // Hide custom alert
        customAlertCloseBtn.addEventListener('click', () => {
            customAlertOverlay.classList.remove('is-visible');
            // Add a small delay for the transition to complete before hiding fully
            setTimeout(() => {
                customAlertOverlay.classList.add('hidden');
            }, 300); 
        });

        // Load data from localStorage on page load
        document.addEventListener('DOMContentLoaded', () => {
            savedFlashcards = JSON.parse(localStorage.getItem('vocabBoostFlashcards')) || [];
            savedNewsletters = JSON.parse(localStorage.getItem('vocabBoostNewsletters')) || [];
            renderSavedFlashcards(); // Render cards instead of select
            renderSavedNewsletters(); // Render cards instead of select
            showTab(activeTab); // Show the initial tab
        });

        // Save data to localStorage
        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        // --- Pronunciation Function ---
        function speakWord(word, lang = 'en-US') {
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = lang;
                speechSynthesis.speak(utterance);
            } else {
                showCustomAlert('Trình duyệt của bạn không hỗ trợ phát âm.');
            }
        }

        // --- Check for duplicate words across all saved flashcards and newsletters ---
        function isDuplicateWord(wordToCheck) {
            const lowerCaseWord = wordToCheck.toLowerCase();
            // Check in saved flashcards
            const flashcardWords = savedFlashcards.flatMap(set => set.words.map(w => w.word.toLowerCase()));
            if (flashcardWords.includes(lowerCaseWord)) {
                return true;
            }

            // Check in saved newsletters (extract highlighted words)
            const newsletterWords = savedNewsletters.flatMap(nl => {
                const doc = new DOMParser().parseFromString(nl.content, 'text/html');
                const highlightedSpans = doc.querySelectorAll('.highlighted-word');
                return Array.from(highlightedSpans).map(span => {
                    // Extract only the text content, excluding the inline pronounce button
                    const tempSpan = document.createElement('span');
                    tempSpan.innerHTML = span.innerHTML;
                    const btn = tempSpan.querySelector('.pronounce-btn-inline');
                    if (btn) btn.remove();
                    return tempSpan.textContent.toLowerCase();
                });
            });
            if (newsletterWords.includes(lowerCaseWord)) {
                return true;
            }

            return false;
        }

        // Show/hide tabs
        function showTab(tabId) {
            activeTab = tabId;
            if (tabId === 'create') {
                createMaterialsSection.classList.remove('hidden');
                reviewLearnSection.classList.add('hidden');
                createTabBtn.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-indigo-600', 'text-white', 'shadow-lg', 'transform', 'scale-105');
                createTabBtn.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600', 'hover:text-white');
                reviewTabBtn.classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-indigo-600', 'text-white', 'shadow-lg', 'transform', 'scale-105');
                reviewTabBtn.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600', 'hover:text-white');
            } else {
                createMaterialsSection.classList.add('hidden');
                reviewLearnSection.classList.remove('hidden');
                reviewTabBtn.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-indigo-600', 'text-white', 'shadow-lg', 'transform', 'scale-105');
                reviewTabBtn.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600', 'hover:text-white');
                createTabBtn.classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-indigo-600', 'text-white', 'shadow-lg', 'transform', 'scale-105');
                createTabBtn.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600', 'hover:text-white');
            }
        }

        // --- Gemini API Call Function ---
        async function callGeminiAPI(prompt, schema = null) {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistory };
            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }

            // API Key của bạn
            const apiKey = "AIzaSyDe33qK44IF_aCXQEOwGqDCZ5iQCN9I5Qg"; 
            // Sử dụng mô hình gemini-2.5-flash
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    return schema ? JSON.parse(text) : text;
                } else {
                    console.error("Unexpected API response structure:", result);
                    throw new Error("Không thể tạo nội dung. Vui lòng thử lại.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                throw new Error(`Lỗi API: ${error.message}`);
            }
        }

        // --- Generate Vocabulary Function ---
        generateVocabBtn.addEventListener('click', async () => {
            vocabLoading.classList.remove('hidden');
            vocabError.classList.add('hidden');
            vocabList.innerHTML = '';
            noVocabMessage.classList.add('hidden');
            saveFlashcardsBtn.classList.add('hidden');
            generateVocabBtn.disabled = true;

            const vocabTopic = vocabTopicInput.value.trim();
            const targetWordCount = 10;
            const maxAttempts = 5; // Tăng số lần thử để bù đắp từ trùng lặp
            let currentGeneratedWords = [];
            
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "word": { "type": "STRING" },
                        "meaning": { "type": "STRING" },
                        "ipa": { "type": "STRING" },
                        "example": { "type": "STRING" }
                    },
                    "propertyOrdering": ["word", "meaning", "ipa", "example"]
                }
            };

            try {
                for (let attempt = 0; attempt < maxAttempts; attempt++) {
                    const wordsNeeded = targetWordCount - currentGeneratedWords.length;
                    if (wordsNeeded <= 0) {
                        break; // Đã đủ số lượng từ
                    }

                    // Yêu cầu nhiều từ hơn một chút để bù đắp các từ trùng lặp
                    const requestCount = wordsNeeded + 3; // Yêu cầu thêm 3 từ mỗi lần thử
                    const prompt = `Tạo một danh sách ${requestCount} từ vựng tiếng Anh trình độ C1/C2 ${vocabTopic ? `liên quan đến chủ đề "${vocabTopic}"` : 'ngẫu nhiên'}. Với mỗi từ, cung cấp nghĩa tiếng Việt, phiên âm IPA và một câu ví dụ. Định dạng JSON như sau:
                    [
                      {
                        "word": "Từ vựng",
                        "meaning": "Nghĩa tiếng Việt",
                        "ipa": "Phiên âm IPA",
                        "example": "Câu ví dụ"
                      }
                    ]
                    `;

                    const data = await callGeminiAPI(prompt, schema);
                    
                    for (const item of data) {
                        if (currentGeneratedWords.length >= targetWordCount) {
                            break; // Dừng thêm nếu đã đạt số lượng mục tiêu
                        }
                        // Kiểm tra từ trùng lặp với các từ đã tạo trong phiên này và các bộ flashcard đã lưu
                        if (!currentGeneratedWords.some(w => w.word.toLowerCase() === item.word.toLowerCase()) && !isDuplicateWord(item.word)) {
                            currentGeneratedWords.push(item);
                        }
                    }

                    if (currentGeneratedWords.length === targetWordCount) {
                        break; // Đã tạo đủ số lượng từ mục tiêu
                    }
                }

                generatedVocab = currentGeneratedWords;
                renderGeneratedVocab();

                if (generatedVocab.length < targetWordCount) {
                    vocabError.textContent = `Chỉ tạo được ${generatedVocab.length} từ. Một số từ bị trùng lặp hoặc không thể tạo thêm. Vui lòng thử lại với chủ đề khác hoặc để trống.`;
                    vocabError.classList.remove('hidden');
                } else {
                    vocabError.classList.add('hidden');
                }

            } catch (error) {
                vocabError.textContent = error.message;
                vocabError.classList.remove('hidden');
            } finally {
                vocabLoading.classList.add('hidden');
                generateVocabBtn.disabled = false;
            }
        });

        // Function to remove a vocabulary word from the generated list
        function removeVocabWord(index) {
            generatedVocab.splice(index, 1); // Remove word from array
            renderGeneratedVocab(); // Re-render the list
            showCustomAlert('Đã xóa từ vựng.');
        }

        function renderGeneratedVocab() {
            vocabList.innerHTML = '';
            if (generatedVocab.length > 0) {
                generatedVocab.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex flex-col md:flex-row items-start md:items-center p-3 bg-gray-700 rounded-md shadow-sm';
                    li.innerHTML = `
                        <div class="flex-1">
                            <p class="text-lg font-medium text-purple-300">${item.word} 
                                <button class="pronounce-btn" data-word="${item.word}" title="Nghe phát âm">&#128266;</button>
                            </p>
                            <p class="text-gray-300 text-sm italic">${item.meaning} - ${item.ipa}</p>
                            <p class="text-gray-400 text-sm">"${item.example}"</p>
                        </div>
                        <button class="delete-vocab-btn ml-4 px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200 btn-gradient-hover" data-index="${index}">Xóa</button>
                    `;
                    vocabList.appendChild(li);
                });
                // Attach event listeners to delete buttons
                document.querySelectorAll('.delete-vocab-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const index = parseInt(event.target.dataset.index);
                        removeVocabWord(index);
                    });
                });
                // Attach event listeners to pronounce buttons
                document.querySelectorAll('.pronounce-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const wordToSpeak = event.target.dataset.word;
                        speakWord(wordToSpeak);
                    });
                });
                saveFlashcardsBtn.classList.remove('hidden');
            } else {
                noVocabMessage.classList.remove('hidden');
                saveFlashcardsBtn.classList.add('hidden');
            }
        }

        // --- Generate Newsletter Function ---
        generateNewsletterBtn.addEventListener('click', async () => {
            newsletterLoading.classList.remove('hidden');
            newsletterError.classList.add('hidden');
            newsletterContentDiv.innerHTML = '';
            noNewsletterMessage.classList.add('hidden');
            saveNewsletterBtn.classList.add('hidden');
            generateNewsletterBtn.disabled = true;

            const newsletterTopic = newsletterTopicInput.value.trim();
            // Explicitly tell AI not to use markdown and no introductory/concluding phrases
            const prompt = `Viết một bản tin ngắn bằng tiếng Anh (khoảng 150-200 từ) ${newsletterTopic ? `liên quan đến chủ đề "${newsletterTopic}"` : 'ngẫu nhiên'}. KHÔNG sử dụng bất kỳ định dạng Markdown nào như **bold** hay __underline__. KHÔNG bao gồm bất kỳ lời giới thiệu hay kết luận nào như "Here's a news bulletin", "In conclusion", "Okay, here's a news bulletin on...", "This report details...", "The following news report...", "Here is a brief news update...", "This newsletter focuses on...", "We're bringing you a report on...", "Here's an overview of...", "This article discusses...", "Below is a news piece on...", "This bulletin provides information on...", "Here's a summary of...", "In this report, we cover...". Chỉ cung cấp nội dung bản tin. Trong bản tin này, hãy sử dụng ít nhất 5-7 từ vựng trình độ C1/C2. Ngay sau mỗi từ vựng C1/C2, trong dấu ngoặc đơn, cung cấp nghĩa tiếng Việt và phiên âm IPA của từ đó. Ví dụ: "The ubiquitous (phổ biến - /juːˈbɪkwitəs/) nature of technology..." Đảm bảo các từ vựng được highlight không trùng lặp với các từ đã có trong các bộ flashcard đã lưu.`;

            try {
                let text = await callGeminiAPI(prompt);

                // Post-processing to remove common introductory phrases if AI still generates them
                const introPhrases = [
                    /^Okay, here's a news bulletin(?: on .*?)?:/i,
                    /^Here's a short news report(?: on .*?)?:/i,
                    /^News Bulletin: (?:.*?)?:/i,
                    /^In this report, we cover(?:.*?)?:/i,
                    /^This report details(?:.*?)?:/i,
                    /^The following news report(?:.*?)?:/i,
                    /^Here is a brief news update(?:.*?)?:/i,
                    /^This newsletter focuses on(?:.*?)?:/i,
                    /^We're bringing you a report on(?:.*?)?:/i,
                    /^Here's an overview of(?:.*?)?:/i,
                    /^This article discusses(?:.*?)?:/i,
                    /^Below is a news piece on(?:.*?)?:/i,
                    /^This bulletin provides information on(?:.*?)?:/i,
                    /^Here's a summary of(?:.*?)?:/i,
                    /^Here's a news bulletin, incorporating C1\/C2 vocabulary with definitions and IPA transcriptions: News Bulletin: /i // Specific phrase from user's image
                ];
                for (const phraseRegex of introPhrases) {
                    text = text.replace(phraseRegex, '').trim();
                }

                // Regex to find words in "WORD (meaning - ipa)" format, and also handle potential markdown remnants
                const processedText = text.replace(/(\*\*|__)?([A-Za-z'-]+)(\*\*|__)?\s*\(([^)]*?)\s*-\s*([^)]*?)\)/g, (match, preBold, word, postBold, meaning, ipa) => {
                    // Clean the word from any markdown bold/underline remnants
                    const cleanWord = word.replace(/\*\*|__/g, '');
                    if (isDuplicateWord(cleanWord)) {
                        return cleanWord; // If duplicate, return plain word
                    } else {
                        // Wrap word in a span with data attributes for meaning and IPA, and add inline pronounce button
                        return `<span class="highlighted-word" data-meaning="${meaning.trim()}" data-ipa="${ipa.trim()}">${cleanWord}<button class="pronounce-btn pronounce-btn-inline" data-word="${cleanWord}" title="Nghe phát âm">&#128266;</button></span>`;
                    }
                });
                generatedNewsletterHtml = processedText;
                renderGeneratedNewsletter();
            } catch (error) {
                newsletterError.textContent = error.message;
                newsletterError.classList.remove('hidden');
            } finally {
                newsletterLoading.classList.add('hidden');
                generateNewsletterBtn.disabled = false;
            }
        });

        function renderGeneratedNewsletter() {
            if (generatedNewsletterHtml) {
                newsletterContentDiv.innerHTML = generatedNewsletterHtml;
                newsletterContentDiv.classList.remove('hidden');
                noNewsletterMessage.classList.add('hidden');
                saveNewsletterBtn.classList.remove('hidden');
                // Attach event listeners to newly created inline pronounce buttons
                newsletterContentDiv.querySelectorAll('.pronounce-btn-inline').forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.stopPropagation(); // Prevent popup from showing when clicking pronounce button
                        const wordToSpeak = event.target.dataset.word;
                        speakWord(wordToSpeak);
                    });
                });
            } else {
                newsletterContentDiv.innerHTML = '';
                newsletterContentDiv.classList.add('hidden');
                noNewsletterMessage.classList.remove('hidden');
                saveNewsletterBtn.classList.add('hidden');
            }
        }

        // --- Save Data Functions ---
        saveFlashcardsBtn.addEventListener('click', () => {
            if (generatedVocab.length === 0) {
                showCustomAlert('Không có từ vựng nào để lưu.');
                return;
            }
            const newSet = {
                id: Date.now(),
                name: vocabTopicInput.value.trim() || `Bộ từ vựng ngẫu nhiên ${new Date().toLocaleDateString('vi-VN')}`,
                words: generatedVocab
            };
            savedFlashcards.push(newSet);
            saveData('vocabBoostFlashcards', savedFlashcards);
            generatedVocab = []; // Clear generated vocab after saving
            vocabTopicInput.value = '';
            renderGeneratedVocab(); // Re-render to clear display
            renderSavedFlashcards(); // Re-render saved flashcard grid
            showCustomAlert('Bộ flashcard đã được lưu thành công!');
        });

        saveNewsletterBtn.addEventListener('click', () => {
            if (!generatedNewsletterHtml) {
                showCustomAlert('Không có bản tin nào để lưu.');
                return;
            }
            const newNewsletter = {
                id: Date.now(),
                name: newsletterTopicInput.value.trim() || `Bản tin ngẫu nhiên ${new Date().toLocaleDateString('vi-VN')}`,
                content: generatedNewsletterHtml
            };
            savedNewsletters.push(newNewsletter);
            saveData('vocabBoostNewsletters', savedNewsletters);
            generatedNewsletterHtml = ''; // Clear generated newsletter after saving
            newsletterTopicInput.value = '';
            renderGeneratedNewsletter(); // Re-render to clear display
            renderSavedNewsletters(); // Re-render saved newsletter grid
            showCustomAlert('Bản tin đã được lưu thành công!');
        });

        // --- Flashcard Learning Functions (Card View) ---

        // Function to delete a saved flashcard set
        function deleteFlashcardSet(setId) {
            savedFlashcards = savedFlashcards.filter(set => set.id !== setId);
            saveData('vocabBoostFlashcards', savedFlashcards);
            renderSavedFlashcards(); // Re-render the grid
            if (activeFlashcardSetId === setId) {
                resetFlashcardDisplay(); // Reset display if the active set was deleted
            }
            showCustomAlert('Đã xóa bộ flashcard.');
        }

        // Function to start learning a flashcard set
        function learnFlashcardSet(setId) {
            const set = savedFlashcards.find(s => s.id === setId);
            if (set) {
                shuffledFlashcards = [...set.words].sort(() => Math.random() - 0.5);
                currentFlashcardIndex = 0;
                isFlipped = false;
                activeFlashcardSetId = setId; // Set the active set
                updateFlashcardDisplay();
                
                // Hide newsletter sections if they are visible
                newsletterListContainer.classList.remove('is-visible');
                newsletterListContainer.classList.add('hidden');
                newsletterReadingArea.classList.remove('is-visible');
                newsletterReadingArea.classList.add('hidden');

                flashcardListContainer.classList.remove('is-visible');
                flashcardListContainer.classList.add('hidden'); // Hide the list of sets immediately after transition starts
                
                setTimeout(() => {
                    flashcardLearningArea.classList.remove('hidden');
                    flashcardLearningArea.classList.add('is-visible'); // Show the learning area with transition
                }, 500); // Delay matches transition duration
            }
        }

        // Function to go back to the flashcard list
        backToFlashcardListBtn.addEventListener('click', () => {
            flashcardLearningArea.classList.remove('is-visible');
            flashcardLearningArea.classList.add('hidden'); // Hide the learning area immediately after transition starts
            
            setTimeout(() => {
                flashcardListContainer.classList.remove('hidden');
                flashcardListContainer.classList.add('is-visible'); // Show the list of sets with transition
                resetFlashcardDisplay(); // Reset display state
            }, 500); // Delay matches transition duration
        });


        function renderSavedFlashcards() {
            savedFlashcardGrid.innerHTML = ''; // Clear current grid
            if (savedFlashcards.length > 0) {
                noSavedFlashcardsMessage.classList.add('hidden');
                savedFlashcards.forEach(set => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 p-4 rounded-lg shadow-md flex flex-col justify-between';
                    card.innerHTML = `
                        <h4 class="text-xl font-semibold text-purple-300 mb-2">${set.name}</h4>
                        <p class="text-gray-400 text-sm mb-4">${set.words.length} từ</p>
                        <div class="flex flex-col space-y-2">
                            <button class="learn-flashcard-btn px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-bold rounded-md hover:from-blue-600 hover:to-cyan-600 transition duration-300 btn-gradient-hover" data-id="${set.id}">Học</button>
                            <button class="delete-flashcard-set-btn px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300 btn-gradient-hover" data-id="${set.id}">Xóa</button>
                        </div>
                    `;
                    savedFlashcardGrid.appendChild(card);
                });

                // Attach event listeners to the new buttons
                document.querySelectorAll('.learn-flashcard-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const setId = parseInt(event.target.dataset.id);
                        learnFlashcardSet(setId);
                    });
                });
                document.querySelectorAll('.delete-flashcard-set-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const setId = parseInt(event.target.dataset.id);
                        deleteFlashcardSet(setId);
                    });
                });
            } else {
                noSavedFlashcardsMessage.classList.remove('hidden');
                // Ensure list container is visible if no cards, but learning area is hidden
                flashcardListContainer.classList.remove('hidden');
                flashcardListContainer.classList.add('is-visible');
                flashcardLearningArea.classList.add('hidden');
                flashcardLearningArea.classList.remove('is-visible');
            }
        }

        function resetFlashcardDisplay() {
            shuffledFlashcards = [];
            currentFlashcardIndex = 0;
            isFlipped = false;
            activeFlashcardSetId = null;
            flashcardDisplay.classList.add('hidden');
            noFlashcardSetSelectedMessage.classList.remove('hidden');
        }

        function updateFlashcardDisplay() {
            if (shuffledFlashcards.length > 0) {
                const currentCard = shuffledFlashcards[currentFlashcardIndex];
                flashcardWord.textContent = currentCard.word;
                flashcardMeaning.textContent = currentCard.meaning;
                flashcardIPA.textContent = currentCard.ipa;
                flashcardExample.textContent = `"${currentCard.example}"`;
                flashcardCounter.textContent = `Thẻ ${currentFlashcardIndex + 1} / ${shuffledFlashcards.length}`;

                // Set data-word for pronunciation button
                flashcardPronounceBtn.dataset.word = currentCard.word;

                // Reset flip state, then apply if needed for next/prev
                flashcardInner.classList.remove('rotate-y-180');
                isFlipped = false; // Always show front face on new card

                prevFlashcardBtn.disabled = currentFlashcardIndex === 0;
                nextFlashcardBtn.disabled = false; // Always allow next until the very last card
            } else {
                resetFlashcardDisplay();
            }
        }

        flashcardContainer.addEventListener('click', (event) => {
            // Only flip if click is not on the pronounce button
            if (event.target !== flashcardPronounceBtn) {
                isFlipped = !isFlipped;
                if (isFlipped) {
                    flashcardInner.classList.add('rotate-y-180');
                } else {
                    flashcardInner.classList.remove('rotate-y-180');
                }
            }
        });

        flashcardPronounceBtn.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent flashcard from flipping when pronounce button is clicked
            const wordToSpeak = event.target.dataset.word;
            speakWord(wordToSpeak);
        });


        nextFlashcardBtn.addEventListener('click', () => {
            if (currentFlashcardIndex < shuffledFlashcards.length - 1) {
                // Always flip to front before moving to next card, then move
                flashcardInner.classList.remove('rotate-y-180');
                isFlipped = false;
                // Use a slight delay to allow flip animation to start before content updates
                setTimeout(() => {
                    currentFlashcardIndex++;
                    updateFlashcardDisplay();
                }, 300); // Adjust delay to match CSS transition duration
            } else {
                showCustomAlert('Bạn đã hoàn thành bộ flashcard này!');
                nextFlashcardBtn.disabled = true; // Disable next button at the end
            }
        });

        prevFlashcardBtn.addEventListener('click', () => {
            if (currentFlashcardIndex > 0) {
                // Always flip to front before moving to prev card, then move
                flashcardInner.classList.remove('rotate-y-180');
                isFlipped = false;
                // Use a slight delay to allow flip animation to start before content updates
                setTimeout(() => {
                    currentFlashcardIndex--;
                    updateFlashcardDisplay();
                }, 300); // Adjust delay to match CSS transition duration
            } else {
                showCustomAlert('Bạn đang ở thẻ đầu tiên.');
                prevFlashcardBtn.disabled = true; // Disable prev button at the beginning
            }
        });

        // --- Newsletter Learning Functions (Card View) ---

        // Function to delete a saved newsletter
        function deleteNewsletter(nlId) {
            savedNewsletters = savedNewsletters.filter(nl => nl.id !== nlId);
            saveData('vocabBoostNewsletters', savedNewsletters);
            renderSavedNewsletters(); // Re-render the grid
            if (activeNewsletterId === nlId) {
                resetNewsletterDisplay(); // Reset display if the active newsletter was deleted
            }
            showCustomAlert('Đã xóa bản tin.');
        }

        // Function to read a newsletter
        function readNewsletter(nlId) {
            const selectedNewsletter = savedNewsletters.find(nl => nl.id === nlId);
            if (selectedNewsletter) {
                activeNewsletterId = nlId; // Set the active newsletter
                selectedNewsletterContent.innerHTML = selectedNewsletter.content;
                selectedNewsletterContent.classList.remove('hidden');
                noSelectedNewsletterContentMessage.classList.add('hidden');
                
                // Hide flashcard sections if they are visible
                flashcardListContainer.classList.remove('is-visible');
                flashcardListContainer.classList.add('hidden');
                flashcardLearningArea.classList.remove('is-visible');
                flashcardLearningArea.classList.add('hidden');

                newsletterListContainer.classList.remove('is-visible');
                newsletterListContainer.classList.add('hidden'); // Hide the list of newsletters immediately after transition starts
                
                setTimeout(() => {
                    newsletterReadingArea.classList.remove('hidden');
                    newsletterReadingArea.classList.add('is-visible'); // Show the reading area with transition
                    // Attach event listeners to newly created inline pronounce buttons in the reading area
                    selectedNewsletterContent.querySelectorAll('.pronounce-btn-inline').forEach(button => {
                        button.addEventListener('click', (event) => {
                            event.stopPropagation(); // Prevent popup from showing when clicking pronounce button
                            const wordToSpeak = event.target.dataset.word;
                            speakWord(wordToSpeak);
                        });
                    });
                }, 500); // Delay matches transition duration
            }
        }

        // Function to go back to the newsletter list
        backToNewsletterListBtn.addEventListener('click', () => {
            newsletterReadingArea.classList.remove('is-visible');
            newsletterReadingArea.classList.add('hidden'); // Hide the reading area immediately after transition starts
            
            setTimeout(() => {
                newsletterListContainer.classList.remove('hidden');
                newsletterListContainer.classList.add('is-visible'); // Show the list of sets with transition
                resetNewsletterDisplay(); // Reset display state
            }, 500); // Delay matches transition duration
        });

        function renderSavedNewsletters() {
            savedNewsletterGrid.innerHTML = ''; // Clear current grid
            if (savedNewsletters.length > 0) {
                noSavedNewslettersMessage.classList.add('hidden');
                savedNewsletters.forEach(nl => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 p-4 rounded-lg shadow-md flex flex-col justify-between';
                    card.innerHTML = `
                        <h4 class="text-xl font-semibold text-purple-300 mb-2">${nl.name}</h4>
                        <div class="flex flex-col space-y-2">
                            <button class="read-newsletter-btn px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-bold rounded-md hover:from-blue-600 hover:to-cyan-600 transition duration-300 btn-gradient-hover" data-id="${nl.id}">Đọc</button>
                            <button class="delete-newsletter-btn px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300 btn-gradient-hover" data-id="${nl.id}">Xóa</button>
                        </div>
                    `;
                    savedNewsletterGrid.appendChild(card);
                });

                // Attach event listeners to the new buttons
                document.querySelectorAll('.read-newsletter-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const nlId = parseInt(event.target.dataset.id);
                        readNewsletter(nlId);
                    });
                });
                document.querySelectorAll('.delete-newsletter-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const nlId = parseInt(event.target.dataset.id);
                        deleteNewsletter(nlId);
                    });
                });
            } else {
                noSavedNewslettersMessage.classList.remove('hidden');
                // Ensure list container is visible if no newsletters, but reading area is hidden
                newsletterListContainer.classList.remove('hidden');
                newsletterListContainer.classList.add('is-visible');
                newsletterReadingArea.classList.add('hidden');
                newsletterReadingArea.classList.remove('is-visible');
            }
        }

        function resetNewsletterDisplay() {
            activeNewsletterId = null;
            selectedNewsletterContent.innerHTML = '';
            selectedNewsletterContent.classList.add('hidden');
            noSelectedNewsletterContentMessage.classList.remove('hidden');
        }

        // Function to handle word clicks (used by both newsletterContentDiv and selectedNewsletterContent)
        function handleWordClick(event) {
            const target = event.target;
            // Ensure click is on the highlighted word itself, not the pronounce button inside it
            if (target.classList.contains('highlighted-word') && !target.classList.contains('pronounce-btn-inline')) {
                const meaning = target.dataset.meaning;
                const ipa = target.dataset.ipa;

                popupMeaning.textContent = meaning;
                popupIPA.textContent = ipa;

                // Position the popup using fixed positioning relative to the viewport
                const rect = target.getBoundingClientRect();
                // Calculate horizontal center of the target word for better alignment
                const targetCenterX = rect.left + (rect.width / 2);
                const popupWidth = wordPopup.offsetWidth; // Get current width of popup
                let popupLeft = targetCenterX - (popupWidth / 2);

                // Prevent popup from going off-screen to the left
                if (popupLeft < 10) { // 10px padding from left edge
                    popupLeft = 10;
                }
                // Prevent popup from going off-screen to the right
                if (popupLeft + popupWidth > window.innerWidth - 10) { // 10px padding from right edge
                    popupLeft = window.innerWidth - popupWidth - 10;
                }

                wordPopup.style.left = `${popupLeft}px`;
                wordPopup.style.top = `${rect.bottom + 5}px`; // 5px below the word
                
                wordPopup.classList.remove('hidden');
                wordPopup.classList.add('is-visible'); // Trigger transition
            } else if (!target.classList.contains('pronounce-btn-inline')) { // Hide if click outside highlighted word or its pronounce button
                wordPopup.classList.remove('is-visible'); // Trigger transition
                setTimeout(() => {
                    wordPopup.classList.add('hidden');
                }, 200); // Delay matches transition duration
            }
        }

        // Event listeners for clicking on highlighted words in newsletter
        // Apply to both the content div in "create" tab and "review" tab
        newsletterContentDiv.addEventListener('click', handleWordClick); // New: for create tab
        selectedNewsletterContent.addEventListener('click', handleWordClick); // Existing: for review tab

        // Hide popup when clicking anywhere else on the document
        document.addEventListener('click', (event) => {
            // Check if the click was not inside the popup AND not on a highlighted word AND not on an inline pronounce button
            if (!wordPopup.contains(event.target) && !event.target.classList.contains('highlighted-word') && !event.target.classList.contains('pronounce-btn-inline') && wordPopup.classList.contains('is-visible')) {
                wordPopup.classList.remove('is-visible');
                setTimeout(() => {
                    wordPopup.classList.add('hidden');
                }, 200);
            }
        });


        // --- Tab Switching Event Listeners ---
        createTabBtn.addEventListener('click', () => showTab('create'));
        reviewTabBtn.addEventListener('click', () => showTab('review'));

        // --- Enter Key Press Listeners ---
        vocabTopicInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission
                generateVocabBtn.click();
            }
        });

        newsletterTopicInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission
                generateNewsletterBtn.click();
            }
        });

    </script>
</body>
</html>
